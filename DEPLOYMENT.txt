================================================================================
                    KASIOON BOT - DEPLOYMENT GUIDE
================================================================================

This guide will help you deploy the Kasioon Bot on your VPS.

================================================================================
PREREQUISITES
================================================================================

1. Linux VPS (Ubuntu 20.04+ recommended)
2. Docker and Docker Compose installed
3. Domain name (optional but recommended)
4. API Keys:
   - OpenAI API Key OR Anthropic API Key
   - Telegram Bot Token
   - WhatsApp Business API Token (optional)
   - Kasioon.com Marketplace API credentials (TODO: will be provided)

================================================================================
INSTALLATION STEPS
================================================================================

1. CLONE OR UPLOAD THE PROJECT
   
   Upload all files to your VPS at /var/www/html/kasioon-bot/

2. INSTALL DOCKER (if not already installed)
   
   curl -fsSL https://get.docker.com -o get-docker.sh
   sudo sh get-docker.sh
   sudo usermod -aG docker $USER
   
   # Install Docker Compose
   sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
   sudo chmod +x /usr/local/bin/docker-compose

3. CONFIGURE ENVIRONMENT VARIABLES
   
   cd /var/www/html/kasioon-bot
   cp env-config.txt .env
   nano .env
   
   Update the following variables:
   - PORT=3355 (already set)
   - OPENAI_API_KEY or ANTHROPIC_API_KEY
   - TELEGRAM_BOT_TOKEN
   - WHATSAPP_API_TOKEN (optional)
   - WHATSAPP_PHONE_NUMBER_ID (optional)
   - WHATSAPP_VERIFY_TOKEN (optional)
   - KASIOON_API_URL (TODO: update when API docs provided)
   - KASIOON_API_KEY (TODO: update when API docs provided)
   - N8N_USER and N8N_PASSWORD

4. DEPLOY THE APPLICATION
   
   chmod +x deploy.sh
   ./deploy.sh
   
   This will:
   - Create necessary directories
   - Build Docker containers
   - Start all services
   - Check health status

5. CONFIGURE TELEGRAM WEBHOOK
   
   chmod +x setup-telegram.sh
   ./setup-telegram.sh
   
   Enter your webhook URL when prompted:
   https://your-domain.com/api/telegram/webhook

6. CONFIGURE WHATSAPP WEBHOOK
   
   In your Meta Business Dashboard:
   - Go to WhatsApp > Configuration
   - Set webhook URL: https://your-domain.com/api/whatsapp/webhook
   - Set verify token: (use the value from your .env file)
   - Subscribe to messages

7. CONFIGURE N8N (Optional but recommended)
   
   - Access n8n at: http://your-domain.com:5678
   - Login with credentials from .env file
   - Import workflows from n8n/workflows/ directory
   - Configure credentials for each service

================================================================================
SERVICE URLS
================================================================================

API:            http://localhost:3355
n8n:            http://localhost:5678
Nginx:          http://localhost:80

Webhooks:
- Telegram:     http://your-domain.com/api/telegram/webhook
- WhatsApp:     http://your-domain.com/api/whatsapp/webhook

================================================================================
USEFUL COMMANDS
================================================================================

# View logs
docker-compose logs -f

# View specific service logs
docker-compose logs -f api
docker-compose logs -f n8n

# Restart services
docker-compose restart

# Stop services
docker-compose down

# Rebuild and restart
docker-compose up -d --build

# Check service status
docker-compose ps

# Access container shell
docker-compose exec api sh

================================================================================
TESTING
================================================================================

1. Test API Health:
   curl http://localhost:3355/health

2. Test Message Analysis:
   curl -X POST http://localhost:3355/api/analyze \
     -H "Content-Type: application/json" \
     -d '{"message":"أريد سيارة تويوتا في حلب","language":"ar"}'

3. Test Marketplace Search (TODO: update params when API docs provided):
   curl -X POST http://localhost:3355/api/search \
     -H "Content-Type: application/json" \
     -d '{"city":"Aleppo","category":"vehicles","carBrand":"Toyota"}'

4. Test Telegram Bot:
   - Send a message to your bot on Telegram
   - Check logs: docker-compose logs -f api

5. Test WhatsApp:
   - Send a message to your WhatsApp number
   - Check logs: docker-compose logs -f api

================================================================================
SSL CERTIFICATE (PRODUCTION)
================================================================================

For production, you should use SSL certificates:

1. Install Certbot:
   sudo apt-get install certbot python3-certbot-nginx

2. Get SSL certificate:
   sudo certbot --nginx -d your-domain.com

3. Update nginx.conf to use SSL (uncomment SSL section)

4. Restart Nginx:
   docker-compose restart nginx

================================================================================
TROUBLESHOOTING
================================================================================

Problem: Services not starting
Solution: Check logs with `docker-compose logs`

Problem: Telegram webhook not working
Solution: 
- Ensure your domain is accessible from internet
- Check webhook status: 
  curl https://api.telegram.org/bot<TOKEN>/getWebhookInfo

Problem: WhatsApp not receiving messages
Solution:
- Verify webhook URL in Meta Business Dashboard
- Check verify token matches your .env file
- Ensure webhook is subscribed to 'messages' event

Problem: AI not responding
Solution:
- Check API keys in .env file
- Verify API provider (openai/anthropic) in code
- Check logs for API errors

Problem: Marketplace search not working
Solution:
- Verify KASIOON_API_URL is correct
- Check API key is valid
- Ensure API documentation has been implemented (see TODO.txt)
- Test API endpoint directly with curl

================================================================================
MONITORING
================================================================================

1. View real-time logs:
   docker-compose logs -f

2. Check container status:
   docker-compose ps

3. Check resource usage:
   docker stats

4. View API logs:
   tail -f logs/combined.log
   tail -f logs/error.log

================================================================================
BACKUP
================================================================================

Important directories to backup:
- ./logs/          (Application logs)
- ./uploads/       (Uploaded files)
- ./n8n/           (n8n workflows and data)

Database:
docker-compose exec postgres pg_dump -U n8n n8n > backup.sql

================================================================================
UPDATES
================================================================================

To update the application:

1. Pull latest code
2. Rebuild containers:
   docker-compose down
   docker-compose up -d --build
3. Check logs for any errors

================================================================================
SECURITY RECOMMENDATIONS
================================================================================

1. Change default passwords in .env file
2. Use strong API keys
3. Enable SSL certificates for production
4. Restrict access to n8n interface (use VPN or IP whitelist)
5. Regularly update Docker images
6. Monitor logs for suspicious activity
7. Set up firewall rules:
   sudo ufw allow 80/tcp
   sudo ufw allow 443/tcp
   sudo ufw enable

================================================================================
SUPPORT
================================================================================

For issues or questions:
1. Check logs: docker-compose logs -f
2. Review this documentation
3. Check service-specific documentation:
   - n8n: https://docs.n8n.io/
   - Telegram: https://core.telegram.org/bots/api
   - WhatsApp: https://developers.facebook.com/docs/whatsapp

================================================================================

